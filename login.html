<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Hospital - Login</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
    <nav>
        <div class="logo-container">
            <img src="logo.png" alt="Hospital Logo" class="logo">
        </div>
        <a href="index.html" class="btn">Return to Homepage</a>
    </nav>
</header>

<section class="appointment">
    <h2>Login</h2><br><br>
    <form id="appointment-form">
        <div class="form-group">
            <label for="email">E-mail</label>
            <input type="text" autocomplete="on" class="field" id="email" placeholder="E-mail" required>
        </div>

        <div class="form-group">
            <label for="password">Password</label>
            <input type="password" autocomplete="on" class="field" id="password" placeholder="Password">
        </div>

        <div id="otp-section" style="display: none;">
            <label for="otp">Enter OTP</label>
            <input type="text" id="otp" class="field" placeholder="OTP">
            <button id="verifyOtp" class="btn">Verify OTP</button>
        </div>

        <br>
        <button id="signin" class="btn">Log in</button>
    </form>
</section>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, multiFactor, PhoneAuthProvider, RecaptchaVerifier } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD6g1-cHCBJ-lhwFrr8L1ANehyGwkHjw6k",
        authDomain: "hospital-47fce.firebaseapp.com",
        projectId: "hospital-47fce",
        storageBucket: "hospital-47fce.appspot.com",
        messagingSenderId: "54581383019",
        appId: "1:54581383019:web:07333ea8bf1594999b062e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    let verificationId; 

    document.getElementById("signin").addEventListener("click", async (event) => {
        event.preventDefault(); // Prevent page reload
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            if (user.multiFactor.enrolledFactors.length > 0) {
                // 2FA Required
                document.getElementById("otp-section").style.display = "block";
                requestOtp(user);
            } else {
                // No 2FA required, proceed to dashboard
                window.location.href = "https://ashirvaad1.github.io/admin.html";
            }
        } catch (error) {
            alert(error.message);
        }
    });

    async function requestOtp(user) {
        try {
            const recaptchaVerifier = new RecaptchaVerifier(auth, 'otp-section', {
                size: "invisible"
            });

            const multiFactorSession = await multiFactor(user).getSession();
            const phoneAuthProvider = new PhoneAuthProvider(auth);
            verificationId = await phoneAuthProvider.verifyPhoneNumber(user.multiFactor.enrolledFactors[0].uid, multiFactorSession);

            alert("OTP Sent! Check your phone.");
        } catch (error) {
            alert(error.message);
        }
    }

    document.getElementById("verifyOtp").addEventListener("click", async () => {
        const otpCode = document.getElementById("otp").value;

        try {
            const credential = PhoneAuthProvider.credential(verificationId, otpCode);
            await multiFactor(auth.currentUser).enroll(credential);
            alert("2FA verification successful!");
            window.location.href = "https://ashirvaad1.github.io/admin.html";
        } catch (error) {
            alert("OTP Verification Failed: " + error.message);
        }
    });
</script>
</body>
</html>
